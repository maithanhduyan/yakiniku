/**
 * QR Scanner - Lightweight QR code scanner
 * Based on jsQR with simplified API for this app
 */
class QrScanner {
    constructor(video, onDecode, options = {}) {
        this.video = video;
        this.onDecode = onDecode;
        this.options = options;
        this.active = false;
        this.canvas = document.createElement('canvas');
        this.ctx = this.canvas.getContext('2d', { willReadFrequently: true });
        this.scanInterval = null;

        // Create overlay for scan region
        if (options.highlightScanRegion && options.overlay) {
            this.overlay = options.overlay;
            this.setupOverlay();
        }
    }

    setupOverlay() {
        if (!this.overlay) return;
        this.overlay.innerHTML = `
            <svg class="scan-region-highlight-svg" viewBox="0 0 238 238"
                preserveAspectRatio="none"
                style="position:absolute;width:100%;height:100%;left:0;top:0;fill:none;stroke:#d4af37;stroke-width:4;stroke-linecap:round;stroke-linejoin:round">
                <path d="M31 2H10a8 8 0 0 0-8 8v21M207 2h21a8 8 0 0 1 8 8v21m0 176v21a8 8 0 0 1-8 8h-21m-176 0H10a8 8 0 0 1-8-8v-21"/>
            </svg>
        `;
        try {
            this.overlay.firstElementChild.animate(
                { transform: ['scale(.98)', 'scale(1.01)'] },
                { duration: 400, iterations: Infinity, direction: 'alternate', easing: 'ease-in-out' }
            );
        } catch (e) {}
    }

    async start() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
            });
            this.video.srcObject = stream;
            this.video.setAttribute('playsinline', 'true');
            await this.video.play();
            this.active = true;
            this.scanFrame();
            return true;
        } catch (err) {
            console.error('Camera error:', err);
            throw err;
        }
    }

    stop() {
        this.active = false;
        if (this.scanInterval) {
            cancelAnimationFrame(this.scanInterval);
            this.scanInterval = null;
        }
        if (this.video.srcObject) {
            this.video.srcObject.getTracks().forEach(track => track.stop());
            this.video.srcObject = null;
        }
    }

    scanFrame() {
        if (!this.active) return;

        if (this.video.readyState === this.video.HAVE_ENOUGH_DATA) {
            this.canvas.width = this.video.videoWidth;
            this.canvas.height = this.video.videoHeight;
            this.ctx.drawImage(this.video, 0, 0);

            const imageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
            const code = this.decodeQR(imageData);

            if (code) {
                this.onDecode({ data: code });
            }
        }

        this.scanInterval = requestAnimationFrame(() => this.scanFrame());
    }

    // Simple QR detection using native BarcodeDetector if available
    async decodeQR(imageData) {
        if ('BarcodeDetector' in window) {
            try {
                const detector = new BarcodeDetector({ formats: ['qr_code'] });
                const codes = await detector.detect(this.canvas);
                if (codes.length > 0) {
                    return codes[0].rawValue;
                }
            } catch (e) {
                // BarcodeDetector not supported, fall back
            }
        }
        return null;
    }

    static async hasCamera() {
        try {
            const devices = await navigator.mediaDevices.enumerateDevices();
            return devices.some(device => device.kind === 'videoinput');
        } catch (e) {
            return false;
        }
    }

    destroy() {
        this.stop();
    }
}

// Export for module usage
if (typeof module !== 'undefined' && module.exports) {
    module.exports = QrScanner;
}
