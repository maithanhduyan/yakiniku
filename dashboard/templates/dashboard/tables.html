{% extends "base.html" %}

{% block title %}å¸­ç®¡ç† | ç„¼è‚‰ã‚¸ãƒŠãƒ³{% endblock %}
{% block header %}å¸­ç®¡ç†{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- AI Insights Section -->
    <div class="bg-gray-800 rounded-lg p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold">ğŸ¤– AI ã‚¤ãƒ³ã‚µã‚¤ãƒˆ - {{ target_date.strftime('%m/%d') }}</h3>
            <div class="flex items-center gap-2">
                <input type="date"
                       id="insight-date"
                       value="{{ target_date.isoformat() }}"
                       class="bg-gray-700 border border-gray-600 rounded px-3 py-1 text-sm"
                       hx-get="/admin/tables/insights"
                       hx-trigger="change"
                       hx-target="#insights-container"
                       hx-swap="innerHTML"
                       hx-include="[name='branch_code']">
                <input type="hidden" name="branch_code" value="{{ branch_code }}">
            </div>
        </div>

        <div id="insights-container">
            {% if insights %}
                <div class="space-y-3">
                    {% for insight in insights %}
                    <div class="p-4 rounded-lg {% if insight.type == 'warning' %}bg-red-900/30 border border-red-700{% elif insight.type == 'opportunity' %}bg-green-900/30 border border-green-700{% else %}bg-blue-900/30 border border-blue-700{% endif %}">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold">{{ insight.title }}</h4>
                                <p class="text-sm text-gray-300 mt-1">{{ insight.message }}</p>
                                {% if insight.action %}
                                <p class="text-xs text-gray-400 mt-2">ğŸ’¡ {{ insight.action }}</p>
                                {% endif %}
                            </div>
                            <span class="px-2 py-1 text-xs rounded
                                {% if insight.priority >= 4 %}bg-red-600
                                {% elif insight.priority >= 3 %}bg-yellow-600
                                {% else %}bg-gray-600{% endif %}">
                                P{{ insight.priority }}
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-8 text-gray-400">
                    <p>æœ¬æ—¥ã®ã‚¤ãƒ³ã‚µã‚¤ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p>
                    <p class="text-sm mt-2">ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¨­å®šã—ã¦äºˆç´„ã‚’å…¥ã‚Œã‚‹ã¨ã€AIãŒæœ€é©åŒ–ã®ææ¡ˆã‚’è¡Œã„ã¾ã™</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Time Slot Utilization -->
    <div class="bg-gray-800 rounded-lg p-6">
        <h3 class="text-lg font-bold mb-4">ğŸ“Š æ™‚é–“å¸¯åˆ¥ åˆ©ç”¨çŠ¶æ³</h3>

        <div id="slot-summary-container">
            {% if slot_summaries %}
            <div class="overflow-x-auto">
                <div class="flex gap-2 min-w-max pb-2">
                    {% for slot in slot_summaries %}
                    <div class="flex flex-col items-center p-3 rounded-lg min-w-20
                        {% if slot.utilization_rate >= 90 %}bg-red-900/50
                        {% elif slot.utilization_rate >= 70 %}bg-yellow-900/50
                        {% elif slot.utilization_rate >= 30 %}bg-green-900/50
                        {% else %}bg-gray-700{% endif %}">
                        <span class="text-sm font-bold">{{ slot.time_slot }}</span>
                        <div class="relative w-12 h-12 mt-2">
                            <svg class="w-12 h-12 transform -rotate-90">
                                <circle cx="24" cy="24" r="20" stroke="#374151" stroke-width="4" fill="none"/>
                                <circle cx="24" cy="24" r="20"
                                    stroke="{% if slot.utilization_rate >= 90 %}#ef4444{% elif slot.utilization_rate >= 70 %}#eab308{% else %}#22c55e{% endif %}"
                                    stroke-width="4" fill="none"
                                    stroke-dasharray="{{ (slot.utilization_rate * 1.256) }} 125.6"/>
                            </svg>
                            <span class="absolute inset-0 flex items-center justify-center text-xs font-bold">
                                {{ slot.utilization_rate|int }}%
                            </span>
                        </div>
                        <div class="text-xs text-gray-400 mt-1">
                            {{ slot.available_tables }}/{{ slot.total_tables }}å¸­
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% else %}
            <div class="text-center py-8 text-gray-400">
                <p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Gantt Timeline Chart -->
    <div class="bg-gray-800 rounded-lg p-6" id="gantt-container"
         hx-get="/admin/tables/gantt?branch_code={{ branch_code }}&target_date={{ target_date.isoformat() }}"
         hx-trigger="sse:booking_update from:body"
         hx-swap="innerHTML">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold">ğŸ“Š ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ - {{ target_date.strftime('%m/%d') }}</h3>
            <div class="flex items-center gap-4 text-xs">
                <span class="flex items-center gap-1">
                    <span class="w-4 h-3 bg-green-600 rounded"></span> ç¢ºèªæ¸ˆã¿
                </span>
                <span class="flex items-center gap-1">
                    <span class="w-4 h-3 bg-yellow-600 rounded"></span> ç¢ºèªå¾…ã¡
                </span>
                <span class="flex items-center gap-1">
                    <span class="w-4 h-3 bg-purple-600 rounded"></span> VIP
                </span>
                <span class="flex items-center gap-1">
                    <span class="w-4 h-3 bg-gray-600 rounded"></span> ç©ºå¸­
                </span>
                <span class="flex items-center gap-1 ml-2">
                    <span class="w-0.5 h-4 bg-red-500"></span> ç¾åœ¨æ™‚åˆ»
                </span>
            </div>
        </div>

        <div class="overflow-x-auto">
            <div class="min-w-[900px]" id="gantt-timeline">
                <!-- Time Header -->
                <div class="flex border-b border-gray-700 mb-2 relative">
                    <div class="w-28 flex-shrink-0 py-2 px-2 text-sm font-bold text-gray-400">ãƒ†ãƒ¼ãƒ–ãƒ«</div>
                    <div class="flex-1 flex relative" id="time-header">
                        {% for slot in gantt_data.time_slots %}
                        <div class="flex-1 text-center py-2 text-xs text-gray-400 border-l border-gray-700
                            {% if loop.index0 % 2 == 0 %}font-bold{% endif %}"
                            data-slot="{{ slot }}">
                            {{ slot }}
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Table Rows -->
                {% if gantt_data.tables %}
                {% for table in gantt_data.tables %}
                <div class="flex items-center border-b border-gray-700/50 hover:bg-gray-700/30 group table-row"
                     data-table-id="{{ table.id }}"
                     data-table-number="{{ table.table_number }}"
                     data-capacity="{{ table.max_capacity }}">
                    <!-- Table Info -->
                    <div class="w-28 flex-shrink-0 py-3 px-2">
                        <div class="flex items-center gap-2">
                            <span class="text-lg">
                                {% if table.table_type == 'private' %}ğŸšª
                                {% elif table.max_capacity >= 6 %}ğŸ›‹ï¸
                                {% else %}ğŸª‘{% endif %}
                            </span>
                            <div>
                                <div class="font-bold text-sm">{{ table.table_number }}</div>
                                <div class="text-xs text-gray-500">{{ table.max_capacity }}å</div>
                            </div>
                        </div>
                    </div>

                    <!-- Timeline Grid (Drop Zone) -->
                    <div class="flex-1 flex relative h-12 timeline-dropzone"
                         data-table-id="{{ table.id }}"
                         ondragover="handleDragOver(event)"
                         ondragleave="handleDragLeave(event)"
                         ondrop="handleDrop(event)">
                        <!-- Background grid -->
                        {% for slot in gantt_data.time_slots %}
                        <div class="flex-1 border-l border-gray-700/50 {% if loop.index0 % 2 == 0 %}bg-gray-700/20{% endif %}"></div>
                        {% endfor %}

                        <!-- Current Time Marker -->
                        <div class="current-time-marker absolute top-0 bottom-0 w-0.5 bg-red-500 z-20 pointer-events-none"
                             style="display: none;"></div>

                        <!-- Booking Blocks (positioned absolutely) -->
                        {% for booking in table.bookings %}
                        {% if booking.slot_index >= 0 %}
                        {% set slot_width = 100 / gantt_data.time_slots|length %}
                        {% set block_left = booking.slot_index * slot_width %}
                        {% set block_width = booking.duration_slots * slot_width %}
                        <div class="booking-block absolute top-1 bottom-1 rounded-md flex items-center px-2 text-xs font-medium cursor-grab
                            transition-all hover:scale-[1.02] hover:z-10 hover:shadow-lg active:cursor-grabbing
                            {% if booking.status == 'confirmed' %}bg-green-600 hover:bg-green-500
                            {% elif booking.status == 'pending' %}bg-yellow-600 hover:bg-yellow-500
                            {% elif booking.status == 'completed' %}bg-blue-600 hover:bg-blue-500
                            {% else %}bg-purple-600 hover:bg-purple-500{% endif %}"
                            style="left: {{ block_left }}%; width: {{ block_width }}%; min-width: 60px;"
                            title="{{ booking.customer_name }} - {{ booking.guests }}å ({{ booking.time_str }})"
                            draggable="true"
                            data-booking-id="{{ booking.id }}"
                            data-guests="{{ booking.guests }}"
                            data-customer="{{ booking.customer_name }}"
                            data-time="{{ booking.time_str }}"
                            ondragstart="handleDragStart(event)"
                            ondragend="handleDragEnd(event)">
                            <span class="truncate">
                                {{ booking.customer_name[:4] }}{% if booking.customer_name|length > 4 %}..{% endif %}
                                <span class="opacity-75">{{ booking.guests }}å</span>
                            </span>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="text-center py-8 text-gray-400">
                    <p>ãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                </div>
                {% endif %}

                <!-- Unassigned Bookings -->
                {% if gantt_data.unassigned_bookings %}
                <div class="mt-4 pt-4 border-t border-gray-600">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-yellow-400">âš ï¸</span>
                        <span class="text-sm font-bold text-yellow-400">æœªå‰²å½“ã®äºˆç´„ ({{ gantt_data.unassigned_bookings|length }}ä»¶)</span>
                        <span class="text-xs text-gray-500">- ã‚¯ãƒªãƒƒã‚¯ã§ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰²ã‚Šå½“ã¦ã€ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</span>
                    </div>
                    <div class="flex flex-wrap gap-2" id="unassigned-bookings">
                        {% for booking in gantt_data.unassigned_bookings %}
                        <div class="unassigned-booking px-3 py-2 bg-yellow-900/50 border border-yellow-700 rounded-lg text-sm cursor-grab hover:bg-yellow-800/50 hover:border-yellow-500 transition-all"
                             draggable="true"
                             data-booking-id="{{ booking.id }}"
                             data-guests="{{ booking.guests }}"
                             data-customer="{{ booking.customer_name }}"
                             data-time="{{ booking.time_str }}"
                             onclick="openAssignModal('{{ booking.id }}', '{{ booking.customer_name }}', {{ booking.guests }}, '{{ booking.time_str }}')"
                             ondragstart="handleDragStart(event)"
                             ondragend="handleDragEnd(event)">
                            <span class="font-bold">{{ booking.time_str }}</span>
                            <span class="mx-1">Â·</span>
                            <span>{{ booking.customer_name }}</span>
                            <span class="text-yellow-400">({{ booking.guests }}å)</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Current Time Indicator Info -->
        <div class="mt-4 pt-4 border-t border-gray-700 flex justify-between text-xs text-gray-400">
            <span>â€» å„äºˆç´„ã¯ç´„90åˆ†ã‚’æƒ³å®š | ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§ãƒ†ãƒ¼ãƒ–ãƒ«å¤‰æ›´å¯èƒ½</span>
            <span id="last-update-time">æœ€çµ‚æ›´æ–°: <span class="update-timestamp">{{ target_date.strftime('%Y/%m/%d') }}</span></span>
        </div>
    </div>

    <!-- Table Management -->
    <div class="bg-gray-800 rounded-lg p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold">ğŸª‘ ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§</h3>
            <div class="flex gap-2">
                <button onclick="openAddTableModal()"
                        class="px-4 py-2 bg-gold text-black rounded font-bold text-sm hover:bg-yellow-500">
                    + æ–°è¦è¿½åŠ 
                </button>
                <button hx-post="/admin/tables/seed?branch_code={{ branch_code }}"
                        hx-target="#tables-container"
                        hx-swap="innerHTML"
                        class="px-4 py-2 bg-gray-600 text-white rounded text-sm hover:bg-gray-500">
                    ğŸŒ± ã‚µãƒ³ãƒ—ãƒ«ç”Ÿæˆ
                </button>
            </div>
        </div>

        <div id="tables-container">
            {% if tables %}
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                {% for table in tables %}
                <div class="bg-gray-700 rounded-lg p-4 text-center relative
                    {% if not table.is_active %}opacity-50{% endif %}"
                    hx-get="/admin/tables/{{ table.id }}"
                    hx-trigger="click"
                    hx-target="#table-detail-modal"
                    style="cursor: pointer;">
                    <div class="text-2xl mb-2">
                        {% if table.table_type == 'private' %}ğŸšª
                        {% elif table.features.has_window %}ğŸªŸ
                        {% else %}ğŸª‘{% endif %}
                    </div>
                    <div class="font-bold">{{ table.table_number }}</div>
                    <div class="text-sm text-gray-400">{{ table.name or '' }}</div>
                    <div class="text-xs mt-2 px-2 py-1 rounded inline-block
                        {% if table.max_capacity <= 4 %}bg-blue-900
                        {% elif table.max_capacity <= 6 %}bg-green-900
                        {% else %}bg-purple-900{% endif %}">
                        {{ table.max_capacity }}åå¸­
                    </div>
                    <div class="text-xs text-gray-500 mt-1">{{ table.zone or 'ã‚¾ãƒ¼ãƒ³æœªè¨­å®š' }}</div>
                    {% if table.status != 'available' %}
                    <div class="absolute top-2 right-2 w-3 h-3 rounded-full
                        {% if table.status == 'occupied' %}bg-red-500
                        {% elif table.status == 'reserved' %}bg-yellow-500
                        {% else %}bg-gray-500{% endif %}"></div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-8">
                <div class="text-6xl mb-4">ğŸª‘</div>
                <p class="text-gray-400 mb-4">ãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                <button hx-post="/admin/tables/seed?branch_code={{ branch_code }}"
                        hx-target="#tables-container"
                        hx-swap="innerHTML"
                        class="px-6 py-3 bg-gold text-black rounded-lg font-bold hover:bg-yellow-500">
                    ã‚µãƒ³ãƒ—ãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç”Ÿæˆ
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Capacity Summary -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="bg-gray-800 rounded-lg p-4 text-center">
            <div class="text-3xl font-bold text-white">{{ total_tables }}</div>
            <div class="text-sm text-gray-400">ç·ãƒ†ãƒ¼ãƒ–ãƒ«æ•°</div>
        </div>
        <div class="bg-gray-800 rounded-lg p-4 text-center">
            <div class="text-3xl font-bold text-gold">{{ total_capacity }}</div>
            <div class="text-sm text-gray-400">ç·å¸­æ•°</div>
        </div>
        <div class="bg-gray-800 rounded-lg p-4 text-center">
            <div class="text-3xl font-bold text-green-400">{{ tables_4_seat }}</div>
            <div class="text-sm text-gray-400">4åå¸­</div>
        </div>
        <div class="bg-gray-800 rounded-lg p-4 text-center">
            <div class="text-3xl font-bold text-blue-400">{{ tables_6_seat }}</div>
            <div class="text-sm text-gray-400">6åå¸­+</div>
        </div>
    </div>
</div>

<!-- Table Detail Modal -->
<div id="table-detail-modal"></div>

<!-- Add Table Modal -->
<div id="add-table-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-gray-800 rounded-lg p-6 w-full max-w-md mx-4">
        <h3 class="text-lg font-bold mb-4">æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ </h3>
        <form hx-post="/admin/tables/create?branch_code={{ branch_code }}"
              hx-target="#tables-container"
              hx-swap="innerHTML"
              hx-on::after-request="closeAddTableModal()">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå· *</label>
                    <input type="text" name="table_number" required
                           class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2"
                           placeholder="A1, VIP1, etc.">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">åç§°</label>
                    <input type="text" name="name"
                           class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2"
                           placeholder="çª“éš›å¸­ã€å€‹å®¤A ãªã©">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">å¸­æ•° *</label>
                        <select name="max_capacity" required
                                class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2">
                            <option value="2">2å</option>
                            <option value="4" selected>4å</option>
                            <option value="6">6å</option>
                            <option value="8">8å</option>
                            <option value="10">10å</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">ã‚¿ã‚¤ãƒ—</label>
                        <select name="table_type"
                                class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2">
                            <option value="regular">é€šå¸¸å¸­</option>
                            <option value="private">å€‹å®¤</option>
                            <option value="counter">ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">ã‚¾ãƒ¼ãƒ³</label>
                    <input type="text" name="zone"
                           class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2"
                           placeholder="A, B, VIP ãªã©">
                </div>
                <div class="flex gap-4">
                    <label class="flex items-center gap-2">
                        <input type="checkbox" name="has_window" value="true" class="rounded">
                        <span class="text-sm">çª“éš›</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" name="has_baby_chair" value="true" class="rounded">
                        <span class="text-sm">å­ä¾›æ¤…å­</span>
                    </label>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button type="button" onclick="closeAddTableModal()"
                        class="flex-1 px-4 py-2 bg-gray-600 rounded hover:bg-gray-500">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button type="submit"
                        class="flex-1 px-4 py-2 bg-gold text-black rounded font-bold hover:bg-yellow-500">
                    è¿½åŠ 
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function openAddTableModal() {
    document.getElementById('add-table-modal').classList.remove('hidden');
    document.getElementById('add-table-modal').classList.add('flex');
}

function closeAddTableModal() {
    document.getElementById('add-table-modal').classList.add('hidden');
    document.getElementById('add-table-modal').classList.remove('flex');
}

// Close modal on backdrop click
document.getElementById('add-table-modal').addEventListener('click', function(e) {
    if (e.target === this) closeAddTableModal();
});

// ==========================================
// DRAG & DROP FUNCTIONALITY
// ==========================================
let draggedBooking = null;

function handleDragStart(e) {
    draggedBooking = {
        id: e.target.dataset.bookingId,
        guests: parseInt(e.target.dataset.guests),
        customer: e.target.dataset.customer,
        time: e.target.dataset.time
    };
    e.target.style.opacity = '0.5';
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', draggedBooking.id);

    // Highlight valid drop zones
    document.querySelectorAll('.timeline-dropzone').forEach(zone => {
        const capacity = parseInt(zone.closest('.table-row').dataset.capacity);
        if (capacity >= draggedBooking.guests) {
            zone.classList.add('drop-highlight');
        } else {
            zone.classList.add('drop-invalid');
        }
    });
}

function handleDragEnd(e) {
    e.target.style.opacity = '1';
    draggedBooking = null;

    // Remove all highlights
    document.querySelectorAll('.timeline-dropzone').forEach(zone => {
        zone.classList.remove('drop-highlight', 'drop-invalid', 'drop-active');
    });
}

function handleDragOver(e) {
    e.preventDefault();
    const zone = e.currentTarget;
    const capacity = parseInt(zone.closest('.table-row').dataset.capacity);

    if (draggedBooking && capacity >= draggedBooking.guests) {
        e.dataTransfer.dropEffect = 'move';
        zone.classList.add('drop-active');
    } else {
        e.dataTransfer.dropEffect = 'none';
    }
}

function handleDragLeave(e) {
    e.currentTarget.classList.remove('drop-active');
}

async function handleDrop(e) {
    e.preventDefault();
    const zone = e.currentTarget;
    zone.classList.remove('drop-active');

    if (!draggedBooking) return;

    const tableId = zone.dataset.tableId;
    const tableRow = zone.closest('.table-row');
    const tableNumber = tableRow.dataset.tableNumber;
    const capacity = parseInt(tableRow.dataset.capacity);

    if (capacity < draggedBooking.guests) {
        showToast(`âŒ ${tableNumber} (${capacity}åå¸­) ã¯ ${draggedBooking.guests}åã«å¯¾å¿œã§ãã¾ã›ã‚“`, 'error');
        return;
    }

    // Call API to assign table
    try {
        const response = await fetch(`/api/tables/optimization/assign/${draggedBooking.id}?table_id=${tableId}&branch_code={{ branch_code }}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        if (response.ok) {
            showToast(`âœ… ${draggedBooking.customer} ã‚’ ${tableNumber} ã«å‰²ã‚Šå½“ã¦ã¾ã—ãŸ`, 'success');
            // Trigger HTMX refresh
            htmx.trigger('#gantt-container', 'refresh');
            // Reload page to update Gantt
            setTimeout(() => location.reload(), 500);
        } else {
            const error = await response.json();
            showToast(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.detail || 'å‰²ã‚Šå½“ã¦ã«å¤±æ•—ã—ã¾ã—ãŸ'}`, 'error');
        }
    } catch (err) {
        showToast('âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
    }
}

// ==========================================
// CLICK TO ASSIGN MODAL
// ==========================================
let currentAssignBooking = null;

function openAssignModal(bookingId, customerName, guests, time) {
    currentAssignBooking = { id: bookingId, customer: customerName, guests, time };

    const modal = document.getElementById('assign-table-modal');
    const info = document.getElementById('assign-booking-info');
    const tableList = document.getElementById('assign-table-list');

    info.innerHTML = `<strong>${time}</strong> - ${customerName} <span class="text-yellow-400">(${guests}å)</span>`;

    // Build table options
    const tables = document.querySelectorAll('.table-row');
    let html = '';
    tables.forEach(row => {
        const tableId = row.dataset.tableId;
        const tableNumber = row.dataset.tableNumber;
        const capacity = parseInt(row.dataset.capacity);
        const isValid = capacity >= guests;

        html += `
            <button onclick="assignToTable('${tableId}', '${tableNumber}')"
                    class="p-3 rounded-lg border text-left transition-all ${isValid
                        ? 'bg-gray-700 border-gray-600 hover:border-green-500 hover:bg-gray-600 cursor-pointer'
                        : 'bg-gray-800 border-gray-700 opacity-50 cursor-not-allowed'}"
                    ${isValid ? '' : 'disabled'}>
                <div class="flex justify-between items-center">
                    <span class="font-bold">${tableNumber}</span>
                    <span class="text-sm ${isValid ? 'text-green-400' : 'text-red-400'}">${capacity}åå¸­</span>
                </div>
                ${!isValid ? '<div class="text-xs text-red-400 mt-1">å¸­æ•°ä¸è¶³</div>' : ''}
            </button>
        `;
    });
    tableList.innerHTML = html;

    modal.classList.remove('hidden');
    modal.classList.add('flex');
}

function closeAssignModal() {
    document.getElementById('assign-table-modal').classList.add('hidden');
    document.getElementById('assign-table-modal').classList.remove('flex');
    currentAssignBooking = null;
}

async function assignToTable(tableId, tableNumber) {
    if (!currentAssignBooking) return;

    try {
        const response = await fetch(`/api/tables/optimization/assign/${currentAssignBooking.id}?table_id=${tableId}&branch_code={{ branch_code }}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        if (response.ok) {
            showToast(`âœ… ${currentAssignBooking.customer} ã‚’ ${tableNumber} ã«å‰²ã‚Šå½“ã¦ã¾ã—ãŸ`, 'success');
            closeAssignModal();
            setTimeout(() => location.reload(), 500);
        } else {
            const error = await response.json();
            showToast(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.detail || 'å‰²ã‚Šå½“ã¦ã«å¤±æ•—ã—ã¾ã—ãŸ'}`, 'error');
        }
    } catch (err) {
        showToast('âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
    }
}

// Auto-assign button
async function autoAssign(bookingId, customerName) {
    try {
        const response = await fetch(`/api/tables/optimization/assign/${bookingId}?branch_code={{ branch_code }}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        if (response.ok) {
            const data = await response.json();
            showToast(`âœ… ${customerName} ã‚’ ${data.table_number} ã«è‡ªå‹•å‰²ã‚Šå½“ã¦ã—ã¾ã—ãŸ`, 'success');
            closeAssignModal();
            setTimeout(() => location.reload(), 500);
        } else {
            const error = await response.json();
            showToast(`âŒ è‡ªå‹•å‰²ã‚Šå½“ã¦å¤±æ•—: ${error.detail || 'é©åˆ‡ãªãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'}`, 'error');
        }
    } catch (err) {
        showToast('âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
    }
}

// ==========================================
// CURRENT TIME MARKER
// ==========================================
function updateCurrentTimeMarker() {
    const now = new Date();
    const currentHour = now.getHours();
    const currentMinute = now.getMinutes();

    // Restaurant hours: 17:00 - 23:00
    if (currentHour < 17 || currentHour >= 23) {
        document.querySelectorAll('.current-time-marker').forEach(m => m.style.display = 'none');
        return;
    }

    // Calculate position (17:00 = 0%, 23:00 = 100%)
    const totalMinutes = (currentHour - 17) * 60 + currentMinute;
    const totalRange = 6 * 60; // 6 hours
    const percentage = (totalMinutes / totalRange) * 100;

    document.querySelectorAll('.current-time-marker').forEach(marker => {
        marker.style.display = 'block';
        marker.style.left = percentage + '%';
    });

    // Update timestamp
    const timestamp = document.querySelector('.update-timestamp');
    if (timestamp) {
        timestamp.textContent = now.toLocaleString('ja-JP');
    }
}

// ==========================================
// TOAST NOTIFICATIONS
// ==========================================
function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container') || createToastContainer();

    const toast = document.createElement('div');
    toast.className = `px-4 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full
        ${type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600'}`;
    toast.textContent = message;

    container.appendChild(toast);

    // Animate in
    setTimeout(() => toast.classList.remove('translate-x-full'), 10);

    // Remove after 3s
    setTimeout(() => {
        toast.classList.add('translate-x-full');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toast-container';
    container.className = 'fixed top-4 right-4 z-50 flex flex-col gap-2';
    document.body.appendChild(container);
    return container;
}

// ==========================================
// INITIALIZATION
// ==========================================
document.addEventListener('DOMContentLoaded', function() {
    // Update current time marker every minute
    updateCurrentTimeMarker();
    setInterval(updateCurrentTimeMarker, 60000);

    // Close assign modal on backdrop click
    const assignModal = document.getElementById('assign-table-modal');
    if (assignModal) {
        assignModal.addEventListener('click', function(e) {
            if (e.target === this) closeAssignModal();
        });
    }
});

// SSE for real-time updates
document.body.addEventListener('sse:booking_update', function(e) {
    console.log('ğŸ“Š Booking update received, refreshing Gantt...');
    // HTMX will handle the refresh via hx-trigger
});
</script>

<!-- Assign Table Modal -->
<div id="assign-table-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-gray-800 rounded-lg p-6 w-full max-w-md mx-4 max-h-[80vh] overflow-y-auto">
        <h3 class="text-lg font-bold mb-4">ğŸª‘ ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰²ã‚Šå½“ã¦</h3>

        <div id="assign-booking-info" class="bg-gray-700 rounded-lg p-3 mb-4">
            <!-- Booking info will be inserted here -->
        </div>

        <div class="mb-4">
            <button onclick="autoAssign(currentAssignBooking?.id, currentAssignBooking?.customer)"
                    class="w-full px-4 py-3 bg-gold text-black rounded-lg font-bold hover:bg-yellow-500 flex items-center justify-center gap-2">
                ğŸ¤– AIã«è‡ªå‹•å‰²ã‚Šå½“ã¦ã‚’ä»»ã›ã‚‹
            </button>
        </div>

        <div class="text-sm text-gray-400 mb-2">ã¾ãŸã¯æ‰‹å‹•ã§é¸æŠ:</div>

        <div id="assign-table-list" class="grid grid-cols-2 gap-2 mb-4">
            <!-- Table options will be inserted here -->
        </div>

        <button onclick="closeAssignModal()"
                class="w-full px-4 py-2 bg-gray-600 rounded-lg hover:bg-gray-500">
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>
    </div>
</div>
{% endblock %}
