# ğŸ¼ Äá» bÃ i Tháº£o luáº­n â€” Table Session UX & Event Sourcing

**NgÃ y**: 2026-02-06
**Chá»§ Ä‘á»**: Thiáº¿t káº¿ tráº£i nghiá»‡m khÃ¡ch hÃ ng yakiniku theo session + Event Sourcing cho `table-order` app
**Äiá»u phá»‘i**: Orchestra Agent

---

## Bá»‘i cáº£nh dá»± Ã¡n

### Há»‡ thá»‘ng hiá»‡n táº¡i
- **App**: `table-order` â€” iPad app Ä‘áº·t mÃ³n táº¡i bÃ n cho nhÃ  hÃ ng thá»‹t nÆ°á»›ng Yakiniku
- **Tech stack**: Vanilla JS + CSS, PWA-ready, no framework
- **Offline-first**: Menu cÃ³ 40 item demo fallback, cart persist localStorage
- **Backend**: FastAPI + SQLAlchemy, event sourcing Ä‘Ã£ cÃ³ `OrderEvent` model vá»›i 23 event types

### Kiáº¿n trÃºc hiá»‡n táº¡i (Frontend)
```
State: {
    sessionId: SESSION_ID,       // Auto-generated hoáº·c tá»« URL param
    tableNumber: 'T5',           // Tá»« URL param
    cart: [],                    // Persist localStorage key: 'table_order_cart'
    orderHistory: [],            // Persist localStorage key: 'yakiniku_history_{TABLE_ID}'
}
```

**Váº¥n Ä‘á» hiá»‡n táº¡i**:
1. `sessionId` táº¡o tá»± Ä‘á»™ng nhÆ°ng **khÃ´ng cÃ³ lifecycle** (khÃ´ng biáº¿t khi nÃ o báº¯t Ä‘áº§u/káº¿t thÃºc)
2. `orderHistory` lÆ°u theo `TABLE_ID`, khÃ´ng theo session â†’ lÆ°á»£t khÃ¡ch trÆ°á»›c láº«n vá»›i lÆ°á»£t sau
3. KhÃ´ng cÃ³ flow **check-in â†’ order â†’ eat â†’ pay â†’ clean â†’ ready** trÃªn iPad
4. KhÃ´ng cÃ³ "cháº¿ Ä‘á»™ dá»n bÃ n" hay "sáºµn sÃ ng Ä‘Ã³n khÃ¡ch má»›i"
5. Cart key `'table_order_cart'` chung cho má»i session

### Backend Event Sourcing (Ä‘Ã£ cÃ³)
```python
# 23 EventTypes:
ORDER_CREATED, ORDER_CONFIRMED, ORDER_PREPARING, ORDER_READY, ORDER_DELIVERED, ORDER_COMPLETED, ORDER_CANCELLED
ITEM_ADDED, ITEM_REMOVED, ITEM_STATUS_CHANGED
SESSION_STARTED, SESSION_ENDED
CALL_STAFF, CALL_WATER, CALL_BILL, CALL_ACKNOWLEDGED
GATEWAY_SENT, GATEWAY_RECEIVED, GATEWAY_FAILED, GATEWAY_RETRY
WS_CONNECTED, WS_DISCONNECTED
ERROR_OCCURRED

# EventSources: TABLE_ORDER, KITCHEN, POS, DASHBOARD, SYSTEM, API
```

### Customer Journey (Fishbone Analysis)
```
PRE-VISIT â†’ ARRIVAL â†’ DINING â†’ POST-VISIT
  Website     Check-in   iPad Ordering    POS Payment
  Booking     Kiosk      Kitchen Display  Loyalty
  Chat AI     Seating    Service Quality  Review
```

---

## YÃªu cáº§u thiáº¿t káº¿

### 1. Session Lifecycle trÃªn iPad
Má»—i lÆ°á»£t khÃ¡ch = 1 session má»›i. Flow:
```
KhÃ¡ch vÃ o bÃ n â†’ Gá»i mÃ³n â†’ Ä‚n â†’ Thanh toÃ¡n â†’ Dá»n bÃ n â†’ Sáºµn sÃ ng
```
Cáº§n thiáº¿t káº¿ rÃµ tá»«ng phase vÃ  transition trÃªn iPad.

### 2. Event Sourcing á»Ÿ Frontend (localStorage)
- Má»—i session lÆ°u riÃªng trong localStorage
- Key format Ä‘á» xuáº¥t: `yakiniku_session_{sessionId}`
- Má»—i event chá»©a: `timestamp`, `type`, `data`, `branch_code`, `table_id`
- CÃ³ thá»ƒ replay events Ä‘á»ƒ rebuild state

### 3. Tráº£i nghiá»‡m Yakiniku Ä‘á»™c Ä‘Ã¡o
NhÃ  hÃ ng thá»‹t nÆ°á»›ng cÃ³ Ä‘áº·c thÃ¹:
- KhÃ¡ch **tá»± nÆ°á»›ng** â†’ cáº§n hÆ°á»›ng dáº«n, timer, nhiá»‡t Ä‘á»™
- Gá»i mÃ³n **nhiá»u láº§n** trong 1 bá»¯a (khÃ´ng pháº£i 1 láº§n nhÆ° nhÃ  hÃ ng thÆ°á»ng)
- **Pairing** thá»‹t + bia/rÆ°á»£u + side dishes
- Tempo Äƒn: appetizer â†’ thá»‹t chÃ­nh â†’ side â†’ dessert
- KhÃ¡ch thÆ°á»ng ngá»“i 60-90 phÃºt

---

## CÃ¢u há»i tháº£o luáº­n (cho cáº£ GPT & Gemini)

### Q1: Session Lifecycle Design
Thiáº¿t káº¿ chi tiáº¿t cÃ¡c phase cá»§a 1 session trÃªn iPad:
- Má»—i phase UI trÃ´ng nhÆ° tháº¿ nÃ o?
- Transition giá»¯a cÃ¡c phase: tá»± Ä‘á»™ng hay manual?
- Khi nÃ o session báº¯t Ä‘áº§u/káº¿t thÃºc?
- Xá»­ lÃ½ edge cases: khÃ¡ch bá» vá», há»‡ thá»‘ng crash, Ä‘á»•i bÃ n?

### Q2: Event Sourcing Strategy (Client-side)
- LÆ°u trá»¯ events tháº¿ nÃ o á»Ÿ localStorage? Schema/format?
- Sync events lÃªn backend khi nÃ o? Real-time hay batch?
- Giá»¯ bao nhiÃªu session history trÃªn device? Retention policy?
- Offline-first: xá»­ lÃ½ conflict khi reconnect?

### Q3: Yakiniku-specific UX Features
Nhá»¯ng tÃ­nh nÄƒng UX nÃ o phÃ¹ há»£p nháº¥t cho nhÃ  hÃ ng thá»‹t nÆ°á»›ng:
- Gá»£i Ã½ mÃ³n (upsell/cross-sell) dá»±a trÃªn gÃ¬?
- Grilling timer/guide cÃ³ cáº§n khÃ´ng? Náº¿u cÃ³, tÃ­ch há»£p tháº¿ nÃ o?
- Course/tempo ordering (khai vá»‹ â†’ thá»‹t â†’ dessert)?
- All-you-can-eat (é£Ÿã¹æ”¾é¡Œ) mode vs Ã  la carte?

### Q4: "Dá»n bÃ n" Mode & Staff Handoff
- iPad hiá»ƒn thá»‹ gÃ¬ á»Ÿ cháº¿ Ä‘á»™ dá»n bÃ n?
- Ai trigger chuyá»ƒn phase (staff via POS, hay auto sau payment)?
- Welcome screen cho khÃ¡ch má»›i trÃ´ng nhÆ° tháº¿ nÃ o?
- Lock screen khi bÃ n Ä‘ang dá»n (trÃ¡nh khÃ¡ch má»›i order nháº§m)?

### Q5: Data Architecture cho Multi-session
- localStorage schema cho nhiá»u sessions trÃªn cÃ¹ng 1 iPad/bÃ n?
- Khi nÃ o xÃ³a old session data?
- Dashboard/analytics: staff cáº§n xem gÃ¬ tá»« session data?
- Privacy: dá»¯ liá»‡u khÃ¡ch hÃ ng cáº§n xá»­ lÃ½ tháº¿ nÃ o?

---

## RÃ ng buá»™c ká»¹ thuáº­t

1. **Vanilla JS only** â€” KhÃ´ng framework (React/Vue/Angular)
2. **Offline-first** â€” Pháº£i hoáº¡t Ä‘á»™ng khi máº¥t máº¡ng
3. **iPad landscape** â€” Primary target 1024Ã—768
4. **Demo mode** â€” Pháº£i cháº¡y Ä‘Æ°á»£c khÃ´ng cáº§n backend
5. **Multi-tenant** â€” `branch_code` pháº£i Ä‘i kÃ¨m má»i data
6. **i18n** â€” Japanese (default) + English
7. **Existing event types** â€” Pháº£i tÆ°Æ¡ng thÃ­ch vá»›i 23 EventType Ä‘Ã£ cÃ³ á»Ÿ backend

## TiÃªu chÃ­ Ä‘Ã¡nh giÃ¡

| TiÃªu chÃ­ | Trá»ng sá»‘ |
|----------|---------|
| Customer delight â€” khÃ¡ch hÃ ng thá»±c sá»± thÃ­ch dÃ¹ng | 30% |
| Technical feasibility â€” triá»ƒn khai Ä‘Æ°á»£c vá»›i Vanilla JS | 25% |
| Staff efficiency â€” giáº£m workload cho nhÃ¢n viÃªn | 20% |
| Data insights â€” dá»¯ liá»‡u há»¯u Ã­ch cho business | 15% |
| Scalability â€” má»Ÿ rá»™ng cho chuá»—i nhÃ  hÃ ng | 10% |
